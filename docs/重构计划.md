2022-05-07

## 以前的错误

经过一段时间的学习，我发现我虽然使用的是异步的代码

但实际上代码完全是以同步方式被执行的。

因为python的async包中，要想异步执行代码，需要把任务打包成task，然后提交到主循环才行。

我这里直接就await的，所以这样的写法是完全无效的。

## 重构的想法

真正实现异步
功能的实现需要好好规划

### 命令触发条件

- 句子前缀：句子开头的前几个字如果与命令匹配，则触发命令。参数用空格分割
- 句中关键词匹配：句子中包含特定关键词，则触发命令。不能携带参数

也就是说，定义每个命令时，要把前缀或关键词与命令的执行函数绑定。

直接学nonebot，用一个装饰器来装饰命令参数。

### 命令接收
命令 参数1 参数2 参数3...
考虑使用描述符？顺便学习一个新的知识点

### 命令冷却时间

为了应对疯狂刷屏的情况，每个命令使用之前要有基础冷却时间。

对每个玩家有单独的命令冷却时间
对每个命令有全局的命令冷却时间

初步想法是，玩家有一个全局命令冷却。

如果在冷却时间内还执行命令，那这个冷却时间就会刷新。
也就是如果一直执行命令，冷却时间一直刷新

`群号:Q号:cooldown`

### 命令使用次数

对每个玩家单独限制每日使用次数
对每个命令全局限制每日使用次数
使用redis缓存

每使用一次，count - 1。
count不存在时，设置一个默认的次数
`群号:Q号:命令名:count`

### 命令使用次数+冷却

比如：每20秒回复1次次数，但是最多只能累计3次
类似能量与充能的概念

记录上一次使用的时间，下一次再用时，计算使用的时间差值，回复能量
`群号:Q号:命令名:energy`
`群号:Q号:命令名:last_time`

### 每日刷新

如果有每日刷新，在运行的时候给以上使用次数、冷却等字段设置一个过期时间即可。

### 命令使用权限

只有超级用户才能使用某种命令
配置超级用户的两种方式
- 数据表里增加一个字段
- 通过配置文件直接填写q号

### 命令使用帮助

每个命令应该有如何使用的帮助提示

## 插件

### 插件加载


插件加载方式：主要修改plugins文件夹

插件可以是一个文件夹，或者单个py文件。

在plugins的`__init__.py`中import即可，哪些插件不想加载了，就注释import语句

但是需要注意插件加载顺序


### 插件编写

包含一个大的类，该类可以包含多个命令。
一个命令就是一个函数，通过
